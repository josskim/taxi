<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>íƒì‹œ í˜¸ì¶œ</title>
<style>
body { font-family: Arial; max-width: 500px; margin: 40px auto; }
input, button { width: 100%; padding: 12px; margin: 8px 0; font-size: 16px; }
button { background: black; color: white; border: none; }
</style>
</head>
<body>


<h3>ê¸°ì‚¬ ìœ„ì¹˜</h3>
<div id="map" style="height:400px;"></div>


<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCiNAdY2FCksg34Zy2PJmhSoclaIW-XFWI&callback=initMap" async defer></script>
<script>
let map;
let markers = {};
let infowindow;

function initMap() {
  map = new google.maps.Map(document.getElementById('map'), {
    zoom: 17, //ê¸°ì¡´ 14 â†’ 16ìœ¼ë¡œ ìƒìŠ¹ í•´ì„œ 4ë°°ë” í™•ëŒ€í•¨.  êµ¬ê¸€ ë§µ ì¤Œ ë ˆë²¨ì—ì„œ 1 ì¦ê°€í•˜ë©´ ë³´ì´ëŠ” ë²”ìœ„ê°€ ëŒ€ëµ 2ë°° ì‘ì•„ì§€ë¯€ë¡œ 2ë‹¨ê³„ ì˜¬ë¦¬ë©´ ì•½ 4ë°° ë” í™•ëŒ€ëœ ì…ˆì…ë‹ˆë‹¤.
    center: {lat: 35.7384, lng: 128.7334}
  });

  infowindow = new google.maps.InfoWindow();

  loadGPS();
  setInterval(loadGPS, 3000);
}

function getOffset(index) {
  const offset = 0.00005;
  return (index % 5) * offset;
}

function loadGPS() {
  if (!map) {
    console.warn("Map is not initialized yet");
    return;
  }

  fetch('/gps')
    .then(r => r.json())
    .then(data => {
      let i = 0;
      for (let id in data) {
        let baseLat = data[id].lat;
        let baseLng = data[id].lng;

        let pos = {
          lat: baseLat + getOffset(i),
          lng: baseLng + getOffset(i + 2)
        };

        let color = "#ff3b3b";

        if (!markers[id]) {
          let marker = new google.maps.Marker({
            position: pos,
            map: map,
            label: {
              text: id.substring(0, 1),
              color: color,
            },
            icon: {
              path: google.maps.SymbolPath.CIRCLE,
              scale: 10,
              fillColor: color,
              fillOpacity: 1,
              strokeColor: "black",
              strokeWeight: 2,
            }
          });

          marker.addListener('click', () => {
            infowindow.setContent(id + " ìœ„ì¹˜");
            infowindow.open(map, marker);
          });

          markers[id] = marker;
        } else {
          markers[id].setPosition(pos);
        }

        i++;
      }
    })
    .catch(e => console.error("GPS load error:", e));
}

</script>



<h2>ğŸš• íƒì‹œ í˜¸ì¶œ</h2>

<input id="from" placeholder="ì¶œë°œì§€">
<input id="to" placeholder="ë„ì°©ì§€">
<input id="phone" placeholder="ì „í™”ë²ˆí˜¸">

<button onclick="send()">íƒì‹œ í˜¸ì¶œí•˜ê¸°</button>

<p id="msg"></p>

<script>
function send() {
  fetch('/request', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({
      from: from.value,
      to: to.value,
      phone: phone.value
    })
  }).then(r=>r.text()).then(t=>{
    msg.innerText = t;
  });
}



setInterval(load, 2000);
load();
</script>


<hr>
<a href="/admin">ğŸ‘‰ ì‚¬ì¥ë‹˜ í™”ë©´</a>

</body>
</html>
