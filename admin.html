<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>íƒì‹œ ì ‘ìˆ˜ ê´€ë¦¬</title>
<style>
body { font-family: Arial; max-width: 700px; margin: 30px auto; }
.card {
  border:1px solid #ccc;
  padding:15px;
  margin:10px 0;
}
.card.completed {
  background-color: #e0e0e0;  /* ì—°í•œ ê·¸ë ˆì´ ì»¬ëŸ¬ */
  color: #777;               /* íšŒìƒ‰ ìŒì˜ìœ¼ë¡œ í…ìŠ¤íŠ¸ ìƒ‰ìƒ ë³€ê²½ */
  border-color: #999;         /* í…Œë‘ë¦¬ë„ ì—°í•˜ê²Œ */
}
button { padding:8px 12px; }
</style>
</head>
<body>

<h3>ê¸°ì‚¬ ìœ„ì¹˜</h3>
<div id="map" style="height:400px;"></div>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCiNAdY2FCksg34Zy2PJmhSoclaIW-XFWI&callback=initMap" async defer></script>
<script>
let map;
let markers = {};
let infowindow;

function initMap() {
  map = new google.maps.Map(document.getElementById('map'), {
    zoom: 17, //ê¸°ì¡´ 14 â†’ 16ìœ¼ë¡œ ìƒìŠ¹ í•´ì„œ 4ë°°ë” í™•ëŒ€í•¨.  êµ¬ê¸€ ë§µ ì¤Œ ë ˆë²¨ì—ì„œ 1 ì¦ê°€í•˜ë©´ ë³´ì´ëŠ” ë²”ìœ„ê°€ ëŒ€ëµ 2ë°° ì‘ì•„ì§€ë¯€ë¡œ 2ë‹¨ê³„ ì˜¬ë¦¬ë©´ ì•½ 4ë°° ë” í™•ëŒ€ëœ ì…ˆì…ë‹ˆë‹¤.
    center: {lat: 35.7384, lng: 128.7334}
  });

  infowindow = new google.maps.InfoWindow();

  loadGPS();
  setInterval(loadGPS, 3000);
}

function getOffset(index) {
  const offset = 0.00005;
  return (index % 5) * offset;
}

function loadGPS() {
  if (!map) {
    console.warn("Map is not initialized yet");
    return;
  }

  fetch('/gps')
    .then(r => r.json())
    .then(data => {
      let i = 0;
      for (let id in data) {
        let baseLat = data[id].lat;
        let baseLng = data[id].lng;

        let pos = {
          lat: baseLat + getOffset(i),
          lng: baseLng + getOffset(i + 2)
        };

        let color = "#ff3b3b";

        if (!markers[id]) {
          let marker = new google.maps.Marker({
            position: pos,
            map: map,
            label: {
              text: id.substring(0, 1),
              color: color,
            },
            icon: {
              path: google.maps.SymbolPath.CIRCLE,
              scale: 10,
              fillColor: color,
              fillOpacity: 1,
              strokeColor: "black",
              strokeWeight: 2,
            }
          });

          marker.addListener('click', () => {
            infowindow.setContent(id + " ìœ„ì¹˜");
            infowindow.open(map, marker);
          });

          markers[id] = marker;
        } else {
          markers[id].setPosition(pos);
        }

        i++;
      }
    })
    .catch(e => console.error("GPS load error:", e));
}


</script>



<h2>ğŸ“‹ íƒì‹œ ì ‘ìˆ˜ ëª©ë¡</h2>
<div id="msg" style="min-height: 24px; margin-bottom: 10px; color:green;"></div>
<div id="list"></div>

<script>
function load() {
  fetch('/list')
  .then(r => r.json())
  .then(data => {
    let html = '';
    data.forEach((r, i) => {
      html += `
      <div class="card" data-index="${i}">
        <b>ì¶œë°œ:</b> ${r.from} <br>
        <b>ë„ì°©:</b> ${r.to} <br>
        <b>ì „í™”:</b> ${r.phone} <br><br>
        <button onclick="done(${i}, this)">ì™„ë£Œ</button>
      </div>`;
    });
    list.innerHTML = html;
  });
}

const msg = document.getElementById('msg');

function done(i, btn) {
  fetch('/done', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({index: i})
  })
  .then(r => r.text())
  .then(text => {
    // ì™„ë£Œ ë©”ì‹œì§€ í•„ìš” ì‹œ í‘œì‹œ ë˜ëŠ” console.log(text);

    // ë²„íŠ¼ì´ ì†í•œ card divë¥¼ ì°¾ì•„ ì™„ë£Œ ìŠ¤íƒ€ì¼ ì ìš©
    const cardDiv = btn.closest('.card');
    if(cardDiv){
      cardDiv.classList.add('completed');
      // ë²„íŠ¼ ë¹„í™œì„±í™” í•´ë²„ë ¤ë„ ì¢‹ìŒ
      btn.disabled = true;
      btn.innerText = "ì™„ë£Œë¨";
    }
  })
  .catch(e => {
    console.error(e);
    alert('ì™„ë£Œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  });
}

setInterval(load, 2000);
load();
</script>

</body>
</html>
