<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>위치 전송</title>
<link rel="stylesheet" href="style.css?v=1.2" />
</head>
<body>


<div class="container" style="max-width:600px; margin:0 auto; padding:8px;">
  <h2>🚕 위치 전송</h2>


  <h3>위치</h3>

  <div class="search-box">
      <input id="searchName" type="text" placeholder="등록 이름 검색 (예: 스테이남천)" class="input" onkeyup="if(window.event.keyCode==13){searchDriver()}" />
      <button onclick="searchDriver()" style="white-space: nowrap; width: 80px;">검색</button>
    </div>
  <div id="map" style="height:400px;"></div>

  <div id="setup" class="card" style="display:none;">
    <p style="margin:0 0 8px;">이름을 입력하세요</p>
    <input id="name" placeholder="예: 스테이남천" class="input" />
    <button onclick="saveName()">확인</button>
  </div>

  <p id="status" class="card" style="margin-top:8px; padding:10px 12px;"></p>
  <button class="secondary" onclick="changeName()">이름 변경</button>
</div>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCiNAdY2FCksg34Zy2PJmhSoclaIW-XFWI&callback=initMap" async defer></script>
<script src="map-script.js"></script>
<script src="form.js?v=3"></script>
<script>
// 1. 기기 고유 ID 생성 (없을 때만 생성하여 고정)
let deviceId = localStorage.getItem("deviceId");
if (!deviceId) {
    deviceId = "dev_" + Math.random().toString(36).substr(2, 9);
    localStorage.setItem("deviceId", deviceId);
}

let driverName = localStorage.getItem("driverName");

function saveName(){
  const nameInput = document.getElementById("name").value.trim();
  if(nameInput === "") return;

  localStorage.setItem("driverName", nameInput);
  driverName = nameInput;
  
  document.getElementById("setup").style.display = "none";
  startGPS();
}

function changeName(){
  localStorage.removeItem("driverName");
  location.reload();
}

function startGPS(){
  if(!driverName){
    document.getElementById("setup").style.display = "block";
    return;
  }

  document.getElementById("status").innerText = "["+driverName+"] 위치 전송중";

  setInterval(() => {
    navigator.geolocation.getCurrentPosition(pos => {
      fetch('https://taxi.prahashop.shop/gps', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          deviceId: deviceId, // 기기 고유 키
          id: driverName,     // 표시될 이름
          lat: pos.coords.latitude,
          lng: pos.coords.longitude
        })
      });
    }, err => console.error(err), { enableHighAccuracy: true });
  }, 3000);
}

startGPS();
</script>
</body>
</html>
