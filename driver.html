<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>기사 위치 전송</title>
<link rel="stylesheet" href="style.css" />
</head>
<body>
<div class="container" style="max-width:600px; margin:0 auto; padding:8px;">
  <h2>🚕 기사 위치 전송</h2>

  <div id="setup" class="card" style="display:none;">
    <p style="margin:0 0 8px;">기사 이름을 입력하세요</p>
    <input id="name" placeholder="예: 스테이남천" class="input" />
    <button onclick="saveName()">확인</button>
  </div>

  <p id="status" class="card" style="margin-top:8px; padding:10px 12px;"></p>
  <button class="secondary" onclick="changeName()">기사 이름 변경</button>
</div>

<script>
// 1. 기기 고유 ID 생성 (없을 때만 생성하여 고정)
let deviceId = localStorage.getItem("deviceId");
if (!deviceId) {
    deviceId = "dev_" + Math.random().toString(36).substr(2, 9);
    localStorage.setItem("deviceId", deviceId);
}

let driverName = localStorage.getItem("driverName");

function saveName(){
  const nameInput = document.getElementById("name").value.trim();
  if(nameInput === "") return;

  localStorage.setItem("driverName", nameInput);
  driverName = nameInput;
  
  document.getElementById("setup").style.display = "none";
  startGPS();
}

function changeName(){
  localStorage.removeItem("driverName");
  location.reload();
}

function startGPS(){
  if(!driverName){
    document.getElementById("setup").style.display = "block";
    return;
  }

  document.getElementById("status").innerText = "기사 ["+driverName+"] 위치 전송중";

  setInterval(() => {
    navigator.geolocation.getCurrentPosition(pos => {
      fetch('/gps', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          deviceId: deviceId, // 기기 고유 키
          id: driverName,     // 표시될 이름
          lat: pos.coords.latitude,
          lng: pos.coords.longitude
        })
      });
    }, err => console.error(err), { enableHighAccuracy: true });
  }, 3000);
}

startGPS();
</script>
</body>
</html>
